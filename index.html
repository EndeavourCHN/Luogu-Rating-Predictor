<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>洛谷 -> CF Rating 预测</title>
  <style>
    body { font-family: sans-serif; background: #f8f9fa; text-align: center; }
    #chart { width: 90%; height: 500px; margin: 20px auto; }
  </style>
</head>
<body>
  <h1>洛谷 -> CF Rating 预测</h1>
  <p>请选择从洛谷下载的 <code>user.json</code> 文件：</p>
  <input type="file" id="file" accept=".json">
  <div id="result"></div>
  <div id="chart"></div>

  <script src="./js/echarts.min.js"></script>
  <script>
    const K_FIXED = 230; // 单题收益
    const L_FIXED = 700; // 缩放分母
    const ALPHA = 0.4625; // 边际收益
    const k = 0.65;
    const p = 3.5;

    const diffColors = {
      0: "#BFBFBF", // 暂无评定 - 灰
      1: "#FE4C61", // 入门 - 红
      2: "#F39C11", // 普及- - 橙
      3: "#FFC116", // 普及/提高- - 黄
      4: "#52C41A", // 普及+/提高 - 绿
      5: "#3498DB", // 提高+/省选- - 蓝
      6: "#9D3DCF", // 省选/NOI- - 紫
      7: "#0E1D69"  // NOI/NOI+/CTSC - 黑
    };

    const diffToCF = {
      1: 800,  // 入门
      2: 1000, // 普及-
      3: 1400, // 普及/提高-
      4: 1800, // 普及+/提高
      5: 2200, // 提高+/省选-
      6: 2700, // 省选/NOI-
      7: 3200  // NOI/NOI+/CTSC
    };

    document.getElementById("file").addEventListener("change", loadFile);

    function loadFile(event){
      const file = event.target.files[0];
      if(!file){ alert("请选择文件"); return; }
      const reader = new FileReader();
      reader.onload = function(){
        try {
          const json = JSON.parse(reader.result);
          const user = json.currentData.user.name || "未知用户";
          const problems = json.currentData.passedProblems || [];
          if(problems.length === 0){
            document.getElementById("result").innerText = "没有找到做题记录";
            return;
          }
          showResult(user, problems);
        } catch(e){
          document.getElementById("result").innerText = "解析文件失败: " + e;
        }
      };
      reader.readAsText(file);
    }

    function showResult(user, problems) {
      const N = problems.length;
      let R = 800;
      let i = 0;

      const sortedProblems = problems.slice().sort((a, b) => {
        if ((a.difficulty ?? 1) === (b.difficulty ?? 1)) {
          return (a.pid || "").localeCompare(b.pid || "");
        }
        return (a.difficulty ?? 1) - (b.difficulty ?? 1);
      });
      
      for (const prob of sortedProblems) {
        i++;
        if (prob.difficulty == 0) continue; // 跳过未评定的题目
        const phi = 1 + k * Math.pow(i / N, p);
        const rating = diffToCF[prob.difficulty];
        const mapped = 800 + (rating - 800) * phi;
        const base_w = Math.pow(i, ALPHA) - Math.pow(i - 1, ALPHA);
        const delta  = mapped - R;
        const scale  = 1 / (1 + Math.exp(-delta / L_FIXED));
        const expected = 1 / (1 + Math.pow(10, delta / 400));
        R += K_FIXED * (1 - expected) * base_w * scale;
      }

      R = Math.round(R);

      const diffCount = Array(8).fill(0);
      let ratingSum = 0;

      problems.forEach(p=>{
        const d = p.difficulty ?? 1;
        diffCount[d]++;
        ratingSum += diffToCF[d] || 700;
      });

      const avgRating = ratingSum / N;
      const adjusted = avgRating + 30 * Math.log(N + 1);
      const r_adjusted = Math.round(adjusted);

      document.getElementById("result").innerHTML = `
        <h3>${user}</h3>
        <p>预测 CF Rating : <b>${R}</b></p>
        <p>平均题目对应 CF Rating: ${avgRating.toFixed(0)}</p>
        <p>总做题数: ${N}</p>
      `;

      const chart = echarts.init(document.getElementById("chart"));
      chart.setOption({
        title: { text: "做题难度分布" },
        xAxis: {
          type: "category",
          data: ["暂无评定","入门","普及-","普及/提高-","普及+/提高","提高+/省选-","省选/NOI-","NOI/NOI+/CTSC"],
          axisLabel: {
            interval: 0,
            rotate: 0,
            formatter: function(value) {
              return value;
            }
          }
        },
        yAxis: { type: "value" },
        series: [{
          data: diffCount,
          type: "bar",
          label: {
            show: true,
            position: 'top',
            color: '#000',
            fontWeight: 'bold'
          },
          itemStyle: {
            color: function(params) {
              return diffColors[params.dataIndex] || "#007bff";
            }
          }
        }]
      });
    }
  </script>
</body>
</html>
